# 系统设计说明文档

## ZJU CS3134M 三维图形游戏项目

---

## 1. 项目概述

### 1.1 项目背景

本项目是浙江大学 CS3134M 计算机图形学课程的大作业，实现了一个基于 OpenGL 的 3D 射击游戏。项目采用 C++17 开发，使用 GLUT 和 GLEW 库进行图形渲染，实现了完整的游戏系统。

### 1.2 项目目标

- 实现基础 3D 图元建模（立方体、球体、圆柱体、圆锥体、棱柱、棱台）
- 实现 3D 模型的导入导出（OBJ 格式）
- 实现材质和纹理编辑功能
- 实现交互式光照系统
- 实现场景漫游功能（轨道旋转、平移、缩放、适应窗口）
- 实现屏幕录制和截图功能
- 额外实现完整的射击游戏玩法

### 1.3 技术规格

| 项目 | 规格 |
|------|------|
| 开发语言 | C++17 |
| 图形库 | OpenGL 1.x（固定管线） |
| 窗口工具库 | GLUT (OpenGL Utility Toolkit) |
| 扩展加载 | GLEW (OpenGL Extension Wrangler) |
| 视频编码 | FFmpeg（可选） |
| 构建系统 | CMake 3.10+ |
| 目标平台 | Windows 32位 |
| IDE | Visual Studio 2019+ |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         主程序 (main.cpp)                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    GLUT 主循环                               ││
│  │  display() → update() → keyboard() → mouse() → motion()    ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ InputHandler  │    │    Scene      │    │      UI       │
│   输入处理    │    │   场景管理    │    │   用户界面    │
└───────────────┘    └───────────────┘    └───────────────┘
        │                     │                     │
        ▼                     ▼                     │
┌───────────────┐    ┌───────────────┐              │
│ Camera系统    │    │ GameObject    │              │
│ ├─Camera      │    │ ├─Player      │              │
│ ├─Controller  │    │ ├─Enemy       │              │
│ └─FreeCamera  │    │ ├─Target      │              │
└───────────────┘    │ └─Shapes      │              │
                     └───────────────┘              │
                              │                     │
        ┌─────────────────────┼─────────────────────┘
        ▼                     ▼
┌───────────────┐    ┌───────────────┐
│ EnemyManager  │    │ Collision     │
│   敌人AI      │    │   碰撞检测    │
└───────────────┘    └───────────────┘
```

### 2.2 模块划分

| 模块 | 职责 | 核心类 |
|------|------|--------|
| 渲染模块 | 3D 场景渲染、光照、纹理 | Scene, Lighting, Texture |
| 相机模块 | 视角控制、场景漫游 | Camera, CameraController, FreeCamera |
| 输入模块 | 键盘鼠标处理 | InputHandler |
| 游戏实体 | 玩家、敌人、子弹、靶子 | Player, Enemy, Bullet, Target |
| AI 模块 | 敌人行为、寻路 | EnemyManager |
| 碰撞模块 | 碰撞检测算法 | CollisionDetector |
| 建模模块 | 基础图元、网格 | Shapes, GenericMesh |
| IO 模块 | 模型导入导出 | MeshIO |
| UI 模块 | 界面、HUD | UI |
| 录制模块 | 视频录制、截图 | ScreenRecorder |

---

## 3. 核心类设计

### 3.1 类继承关系

```
                    GameObject
                        │
        ┌───────────────┼───────────────┐
        │               │               │
      Player         Enemy           Target
        │
      Stob (legacy)

                    Shape (基类)
                        │
    ┌───────┬───────┬───────┬───────┬───────┐
    │       │       │       │       │       │
  Cube  Sphere Cylinder Cone  Prism Frustum
```

### 3.2 GameObject 类

**文件**: `include/GameObject.h`, `src/GameObject.cpp`

**职责**: 所有场景实体的基类

```cpp
class GameObject {
protected:
    Vector3 position;           // 位置
    Vector3 size;               // 尺寸
    Color color;                // 颜色
    CollisionType collisionType; // 碰撞类型

public:
    virtual void draw();        // 虚函数，渲染物体
    bool checkAABBCollision(float x, float z, float radius);

    // Getter/Setter 方法
    Vector3 getPosition() const;
    void setPosition(const Vector3& pos);
    // ...
};
```

**碰撞类型枚举**:
```cpp
enum CollisionType {
    SOLID,      // 实体，不可穿越
    CLIMBABLE,  // 可攀爬
    WALKABLE,   // 可行走
    NONE        // 无碰撞
};
```

### 3.3 Scene 类

**文件**: `include/Scene.h`, `src/Scene.cpp`

**职责**: 中央游戏管理器，管理所有实体

```cpp
class Scene {
private:
    std::vector<GameObject*> gameObjects;  // 静态物体
    std::vector<Bullet*> bullets;          // 子弹
    std::vector<Target*> targets;          // 靶子
    std::vector<Enemy*> enemies;           // 敌人
    std::vector<std::shared_ptr<Shape>> shapes; // 图元形状
    Lighting* lighting;                    // 光照系统

public:
    void draw();                           // 渲染场景
    void update(float deltaTime);          // 更新逻辑

    // 实体管理
    void addGameObject(GameObject* obj);
    void addShape(std::shared_ptr<Shape> shape);
    void fireBullet(Vector3 pos, Vector3 dir);

    // 碰撞检测
    bool checkCollision(float x, float z, float radius);
    void checkBulletCollisions();

    // 场景边界计算（用于自由相机适应窗口）
    void calculateSceneBounds(Vector3& minBound, Vector3& maxBound);

    Lighting* getLighting();
};
```

### 3.4 相机系统

#### 3.4.1 Camera (第一人称相机)

**文件**: `include/Camera.h`, `src/Camera.cpp`

```cpp
class Camera {
private:
    float x, y, z;          // 位置
    float yaw, pitch;       // 视角角度
    float velocityY;        // 垂直速度（用于跳跃）
    bool onGround;          // 是否在地面
    Scene* scene;           // 场景引用（碰撞检测）

public:
    void move(float forward, float right);  // 移动
    void rotate(float deltaYaw, float deltaPitch); // 旋转
    void jump();                            // 跳跃
    void update(float deltaTime);           // 更新（重力、碰撞）
    void applyView();                       // 应用视图矩阵

    Vector3 getForward() const;             // 获取前方向量
    Vector3 getPosition() const;
};
```

#### 3.4.2 CameraController (第三人称相机)

**文件**: `include/camera_controller.h`, `src/camera_controller.cpp`

```cpp
class CameraController {
private:
    float distance;         // 与玩家的距离
    float azimuth;          // 水平角度
    float altitude;         // 垂直角度
    float playerX, playerZ; // 玩家位置

public:
    void handleMouseMotion(int dx, int dy);
    void setPlayerPosition(float x, float z);
    void applyView();
};
```

#### 3.4.3 FreeCamera (自由相机/观察者模式)

**文件**: `include/FreeCamera.h`, `src/FreeCamera.cpp`

```cpp
class FreeCamera {
private:
    Vector3 target;         // 观察目标点
    float distance;         // 与目标的距离
    float azimuth;          // 水平角度（弧度）
    float altitude;         // 垂直角度（弧度）
    bool altPressed;        // Alt键状态

public:
    void orbit(float deltaAzimuth, float deltaAltitude);  // 轨道旋转
    void pan(float deltaX, float deltaY);                  // 平移
    void zoom(float delta);                                // 缩放
    void zoomToFit(Scene* scene);                         // 适应窗口
    void applyView();                                      // 应用视图

    void handleMouseMotion(int dx, int dy, bool leftButton, bool rightButton);
    void handleMouseWheel(int direction);
};
```

### 3.5 Player 类

**文件**: `include/Player.h`, `src/Player.cpp`

```cpp
class Player : public GameObject {
private:
    float health;               // 生命值 (0-100)
    float maxHealth;            // 最大生命值
    Vector3 visionDirection;    // 视线方向
    float velocityY;            // 垂直速度
    bool onGround;              // 是否在地面
    float damageCooldown;       // 受伤冷却时间

public:
    void draw() override;
    void update(float deltaTime);

    void takeDamage(float amount);
    void heal(float amount);
    bool isDead() const;

    void move(float forward, float right);
    void jump();
    void updateVisionDirection(const Vector3& dir);

    float getHealth() const;
    Vector3 getVisionDirection() const;
};
```

### 3.6 Enemy 类

**文件**: `include/Enemy.h`, `src/Enemy.cpp`

```cpp
class Enemy : public GameObject {
private:
    float health;
    float maxHealth;
    Vector3 visionDirection;    // 面向方向

public:
    void draw() override;       // 渲染雪人造型
    void takeDamage(float amount);
    bool isDead() const;

    void setVisionDirection(const Vector3& dir);
    void lookAt(const Vector3& target);
};
```

### 3.7 EnemyManager 类

**文件**: `include/EnemyManager.h`, `src/EnemyManager.cpp`

**职责**: 敌人生成和AI控制

```cpp
class EnemyManager {
private:
    Scene* scene;
    std::vector<Enemy*>& enemies;

    // 生成参数
    int maxEnemies;             // 最大敌人数量
    float spawnInterval;        // 生成间隔
    float spawnRadius;          // 生成半径
    float spawnTimer;           // 生成计时器

    // AI参数
    float moveSpeed;            // 移动速度
    float attackRange;          // 攻击范围
    float playerDamageCooldown; // 玩家受伤冷却

public:
    void update(float deltaTime, const Vector3& playerPos);
    void spawnEnemy(const Vector3& playerPos);

private:
    // AI寻路
    Vector3 calculateMovementDirection(Enemy* enemy, const Vector3& playerPos);
    bool hasLineOfSight(const Vector3& from, const Vector3& to);
    void performMultiRaycast(Enemy* enemy, const Vector3& playerPos,
                             std::vector<float>& rayDistances);
};
```

**AI寻路算法**:
- 使用 9 条射线在 180° 范围内检测障碍物
- 根据射线检测结果计算加权移动方向
- 无障碍时直接追踪玩家
- 有障碍时选择最佳避让方向

### 3.8 CollisionDetector 类

**文件**: `include/CollisionDetector.h`, `src/CollisionDetector.cpp`

**职责**: 基于分离轴定理（SAT）的碰撞检测

```cpp
class CollisionDetector {
public:
    // 主入口
    static bool checkCollision(const GameObject* obj1, const GameObject* obj2);

    // 具体形状碰撞检测
    static bool cylinderCylinder(const Vector3& p1, float r1, float h1,
                                  const Vector3& p2, float r2, float h2);
    static bool sphereSphere(const Vector3& p1, float r1,
                              const Vector3& p2, float r2);
    static bool cylinderSphere(const Vector3& cylPos, float cylR, float cylH,
                                const Vector3& spherePos, float sphereR);
    static bool sphereCube(const Vector3& spherePos, float sphereR,
                           const Vector3& cubeMin, const Vector3& cubeMax);
    static bool cylinderCube(const Vector3& cylPos, float cylR, float cylH,
                              const Vector3& cubeMin, const Vector3& cubeMax);
    static bool cubeCube(const Vector3& min1, const Vector3& max1,
                          const Vector3& min2, const Vector3& max2);

private:
    // 辅助函数
    static float clamp(float value, float min, float max);
    static bool boundingSphereCheck(const GameObject* obj1, const GameObject* obj2);
};
```

### 3.9 Shape 类（基础图元）

**文件**: `include/Shapes.h`, `src/Shapes.cpp`

```cpp
class Shape {
protected:
    Vector3 position;
    Vector3 size;
    Color color;
    Vector3 rotationAxis;
    float rotationAngle;
    unsigned int textureId;

public:
    virtual void draw() = 0;
    virtual std::vector<Triangle> tessellate() const = 0;  // 曲面细分

    void setPosition(const Vector3& pos);
    void setSize(const Vector3& s);
    void setColor(const Color& c);
    void setRotation(const Vector3& axis, float angle);
    void bindTexture(unsigned int texId);
};

// 具体形状类
class Cube : public Shape { /* ... */ };
class Sphere : public Shape { /* ... */ };
class Cylinder : public Shape { /* ... */ };
class Cone : public Shape { /* ... */ };
class Prism : public Shape { /* ... */ };
class Frustum : public Shape { /* ... */ };
```

### 3.10 MeshIO 类

**文件**: `include/MeshIO.h`, `src/MeshIO.cpp`

**职责**: OBJ 格式网格导入导出

```cpp
class MeshIO {
public:
    // 导入
    static GenericMesh importOBJ(const std::string& filepath);

    // 导出单个形状
    static bool exportShapeOBJ(const Shape* shape,
                                const std::string& filepath,
                                bool applyTransform = true);

    // 导出整个场景
    static bool exportSceneOBJ(const Scene* scene,
                                const std::string& filepath);

private:
    static void writeVertex(std::ofstream& file, const Vector3& v);
    static void writeNormal(std::ofstream& file, const Vector3& n);
    static void writeFace(std::ofstream& file, int v1, int v2, int v3);
};
```

### 3.11 Lighting 类

**文件**: `include/Lighting.h`, `src/Lighting.cpp`

```cpp
class Lighting {
private:
    bool enabled;               // 是否启用
    bool isPointLight;          // 点光源/平行光
    float intensity;            // 强度
    Vector3 position;           // 位置
    Vector3 direction;          // 方向（平行光）

    // 光照参数
    float ambient[4];
    float diffuse[4];
    float specular[4];

public:
    void apply();               // 应用光照设置
    void toggle();              // 开关光照
    void toggleType();          // 切换光源类型
    void adjustIntensity(float delta);
    void movePosition(float dx, float dy, float dz);

    void setHeadlightMode(const Vector3& cameraPos, const Vector3& cameraDir);
};
```

### 3.12 UI 类

**文件**: `include/UI.h`, `src/UI.cpp`

```cpp
class UI {
private:
    Scene* scene;
    int selectedObjectIndex;    // 选中的物体索引
    EditState editState;        // 编辑状态

    // 材质编辑器
    float materialR, materialG, materialB;

public:
    void draw();                // 绘制UI
    void drawCrosshair();       // 准星
    void drawHealthBar(float health, float maxHealth);  // 血条
    void drawEditModeUI();      // 编辑模式界面
    void drawGameOver();        // 游戏结束界面

    void handleClick(int x, int y);  // 处理点击
    void selectObject(int index);
    void applyMaterial();
};

enum EditState {
    EDIT_NONE,
    EDIT_MATERIAL,
    EDIT_TEXTURE
};
```

### 3.13 ScreenRecorder 类

**文件**: `include/ScreenRecorder.h`, `src/ScreenRecorder.cpp`

```cpp
class ScreenRecorder {
private:
    bool recording;
    AVFormatContext* formatContext;
    AVCodecContext* codecContext;
    AVFrame* frame;
    AVPacket* packet;
    int frameCount;
    std::string outputPath;

public:
    bool startRecording(const std::string& filename);
    void stopRecording();
    void captureFrame();        // 每帧调用
    bool isRecording() const;

    static void takeScreenshot(const std::string& filename);
};
```

---

## 4. 数据流设计

### 4.1 主循环数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                      GLUT 主循环                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. display() - 渲染阶段                                         │
│    ├─ 清除缓冲区                                                │
│    ├─ 应用相机视图 (Camera/Controller/FreeCamera)              │
│    ├─ 渲染场景 (Scene::draw)                                   │
│    │   ├─ 渲染地面和边界                                       │
│    │   ├─ 渲染 GameObjects                                     │
│    │   ├─ 渲染 Shapes                                          │
│    │   ├─ 渲染 Bullets                                         │
│    │   ├─ 渲染 Targets                                         │
│    │   └─ 渲染 Enemies                                         │
│    ├─ 渲染玩家 (第三人称模式)                                  │
│    ├─ 渲染UI (血条、准星、编辑界面)                            │
│    └─ 交换缓冲区                                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. update() - 逻辑更新阶段 (60 FPS)                             │
│    ├─ 处理输入 (InputHandler::update)                          │
│    ├─ if (gameState == PLAYING):                               │
│    │   ├─ 更新场景 (Scene::update)                             │
│    │   │   ├─ 更新子弹                                         │
│    │   │   └─ 检测子弹碰撞                                     │
│    │   ├─ 更新相机物理                                         │
│    │   ├─ 更新玩家                                             │
│    │   ├─ 更新敌人AI (EnemyManager::update)                    │
│    │   │   ├─ 生成新敌人                                       │
│    │   │   ├─ AI寻路和移动                                     │
│    │   │   └─ 玩家伤害判定                                     │
│    │   └─ 检查游戏结束条件                                     │
│    ├─ if (Free_Camera_Active):                                 │
│    │   └─ 更新自由相机                                         │
│    └─ 录制帧 (if recording)                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. 输入回调                                                     │
│    ├─ keyboard() - 按键按下                                     │
│    ├─ keyboardUp() - 按键释放                                   │
│    ├─ mouse() - 鼠标点击                                        │
│    └─ motion() - 鼠标移动                                       │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 射击系统数据流

```
玩家点击鼠标左键
        │
        ▼
┌───────────────┐
│ InputHandler  │
│ handleMouse() │
└───────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ 确定子弹发射位置和方向                │
│ - 第一人称: Camera位置 + 前方向量     │
│ - 第三人称: Player位置 + 视线方向     │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────┐
│ Scene::       │
│ fireBullet()  │
└───────────────┘
        │
        ▼
┌───────────────┐     ┌───────────────┐
│ 创建 Bullet   │────▶│ 添加到        │
│ 对象          │     │ bullets 列表  │
└───────────────┘     └───────────────┘
        │
        ▼ (每帧更新)
┌───────────────────────────────────────┐
│ Scene::updateBullets()                │
│ - 更新位置 (pos += velocity * dt)     │
│ - 检查生命周期                        │
└───────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│ Scene::checkBulletCollisions()        │
│ - 遍历所有子弹                        │
│ - 检测与 Targets 碰撞                 │
│ - 检测与 Enemies 碰撞                 │
└───────────────────────────────────────┘
        │
        ▼ (命中)
┌───────────────┐     ┌───────────────┐
│ Target/Enemy  │────▶│ 销毁子弹      │
│ takeDamage()  │     │ 从列表移除    │
└───────────────┘     └───────────────┘
```

### 4.3 敌人AI数据流

```
EnemyManager::update(deltaTime, playerPos)
        │
        ├─────────────────────────────────────┐
        ▼                                     ▼
┌───────────────────────┐          ┌───────────────────────┐
│ 生成逻辑              │          │ AI更新逻辑            │
│ - 检查计时器          │          │ - 遍历所有敌人        │
│ - 检查数量上限        │          └───────────────────────┘
│ - 随机位置生成        │                    │
└───────────────────────┘                    ▼
                                  ┌───────────────────────┐
                                  │ 计算移动方向          │
                                  │ calculateMovement()   │
                                  └───────────────────────┘
                                             │
                    ┌────────────────────────┴────────────────────────┐
                    ▼                                                 ▼
         ┌───────────────────┐                            ┌───────────────────┐
         │ 多射线检测        │                            │ 直接追踪          │
         │ (有障碍物)        │                            │ (无障碍物)        │
         │ - 9条射线         │                            │ - 直线朝向玩家    │
         │ - 180°范围        │                            └───────────────────┘
         │ - 加权方向计算    │
         └───────────────────┘
                    │
                    ▼
         ┌───────────────────┐
         │ 更新敌人位置      │
         │ enemy->setPos()   │
         └───────────────────┘
                    │
                    ▼
         ┌───────────────────────────────────┐
         │ 玩家碰撞检测                      │
         │ - 检测距离 < 攻击范围             │
         │ - 检查受伤冷却                    │
         │ - player->takeDamage()            │
         └───────────────────────────────────┘
```

---

## 5. 课程要求实现详情

### 5.1 建模 (Modeling) - 已完成

**实现内容**:
- 6 种基础图元全部实现
- 支持任意位置、大小、颜色设置
- 支持轴角旋转
- 支持纹理映射
- 支持曲面细分（tessellate）导出三角形网格

**代码位置**: `include/Shapes.h`, `src/Shapes.cpp`

**使用示例**:
```cpp
// 创建立方体
auto cube = std::make_shared<Cube>(
    Vector3(0, 1, 0),           // 位置
    Vector3(2, 2, 2),           // 大小
    Color(1.0f, 0.0f, 0.0f)     // 颜色
);
scene->addShape(cube);

// 创建球体
auto sphere = std::make_shared<Sphere>(
    Vector3(5, 2, 0), 2.0f, Color(0, 1, 0), 32, 32
);
scene->addShape(sphere);
```

### 5.2 存储 (Storage) - 已完成

**实现内容**:
- OBJ 格式导入：顶点、法线、纹理坐标、面
- OBJ 格式导出：单个形状或整个场景
- 支持世界坐标/局部坐标切换
- 自动计算法线

**代码位置**: `include/MeshIO.h`, `src/MeshIO.cpp`

**使用示例**:
```cpp
// 导入OBJ
GenericMesh mesh = MeshIO::importOBJ("resources/meshes/imported/model.obj");

// 导出单个形状
MeshIO::exportShapeOBJ(cube.get(), "exported/cube.obj", true);

// 导出整个场景
MeshIO::exportSceneOBJ(scene, "exported/scene.obj");
```

### 5.3 编辑 (Editing) - 已完成

**实现内容**:
- E 键切换编辑模式
- 物体列表显示和选择
- 选中物体高亮显示（青色轮廓）
- RGB 滑块材质编辑器
- 材质应用按钮
- 纹理应用支持

**代码位置**: `include/UI.h`, `src/UI.cpp`

**操作方式**:
1. 按 E 键进入编辑模式
2. 点击物体列表选择物体
3. 调整 RGB 滑块
4. 点击"应用材质"按钮

### 5.4 光照 (Lighting) - 已完成

**实现内容**:
- 完整 OpenGL 光照模型
- L 键开关光照
- K 键切换点光源/平行光
- [ / ] 键调节强度
- 方向键移动光源 (X/Z)
- Page Up/Down 移动光源 (Y)
- 头灯模式（跟随相机）

**代码位置**: `include/Lighting.h`, `src/Lighting.cpp`

### 5.5 漫游 (Navigation) - 已完成

**实现内容**:
- V 键切换自由相机模式
- 鼠标滚轮缩放
- Alt + 左键拖拽轨道旋转
- Alt + 右键拖拽平移
- F 键适应窗口（自动计算场景边界）
- +/- 键键盘缩放

**代码位置**: `include/FreeCamera.h`, `src/FreeCamera.cpp`

**算法说明**:
- 使用球面坐标系 (distance, azimuth, altitude)
- 轨道旋转：调整 azimuth 和 altitude
- 平移：调整 target 点位置
- 缩放：调整 distance
- 适应窗口：计算场景 AABB，设置合适的距离和目标点

### 5.6 记录 (Recording) - 已完成

**实现内容**:
- R 键开始/停止录制
- 基于 FFmpeg 的 H.264 编码
- MP4 格式输出
- 60 FPS 流畅录制
- P 键截图（PNG 格式）
- 自动时间戳命名

**代码位置**: `include/ScreenRecorder.h`, `src/ScreenRecorder.cpp`

**输出位置**:
- 视频: `videos/recording_YYYYMMDD_HHMMSS.mp4`
- 截图: `pics/screenshot_YYYYMMDD_HHMMSS.png`

---

## 6. 游戏系统设计

### 6.1 游戏状态机

```cpp
enum GameState {
    PLAYING,    // 正常游戏
    PAUSED,     // 暂停（自由相机/编辑模式）
    GAME_OVER   // 游戏结束
};
```

**状态转换**:
```
              ┌─────────────────────────────┐
              │                             │
              ▼                             │
         ┌─────────┐    V/E键          ┌─────────┐
         │ PLAYING │◄─────────────────▶│ PAUSED  │
         └─────────┘    V/E键          └─────────┘
              │
              │ 玩家死亡
              ▼
         ┌───────────┐
         │ GAME_OVER │
         └───────────┘
```

### 6.2 玩家系统

- **生命值**: 100 HP
- **受伤冷却**: 1 秒
- **伤害来源**: 敌人接触
- **回血**: 安全区域自动回血

### 6.3 敌人系统

- **造型**: 雪人（球体头 + 圆柱体身体）
- **生命值**: 100 HP
- **最大数量**: 6
- **生成间隔**: 5 秒
- **生成半径**: 玩家周围 20 单位
- **AI行为**: 追踪玩家 + 障碍物避让

### 6.4 子弹系统

- **速度**: 50 单位/秒
- **伤害**: 25 HP
- **生命周期**: 基于距离限制
- **碰撞检测**: 与靶子和敌人

---

## 7. 编译和部署

### 7.1 编译步骤

```powershell
# 方式1: 使用脚本（推荐）
powershell -ExecutionPolicy Bypass -File .\buildAndLaunch.ps1

# 方式2: 手动编译
mkdir build
cd build
cmake -A Win32 ..
cmake --build . --config Release

# 复制依赖
copy ..\lib\glut32.dll Release\
copy ..\lib\glew32.dll Release\
copy ..\external\ffmpeg\bin\*.dll Release\
xcopy ..\resources Release\resources\ /E /I

# 运行
cd Release
.\FirstOGL.exe
```

### 7.2 目录结构（发布版）

```
发布目录/
├── FirstOGL.exe          # 可执行文件
├── glut32.dll            # GLUT库
├── glew32.dll            # GLEW库
├── avcodec-*.dll         # FFmpeg（可选）
├── avformat-*.dll
├── avutil-*.dll
├── swscale-*.dll
└── resources/            # 资源目录
    ├── textures/         # 纹理
    └── meshes/           # 3D模型
```

---

## 8. 演示视频说明

演示视频应包含以下内容：

1. **基础建模演示** (~1分钟)
   - 展示场景中的6种基础图元
   - 演示编辑模式下的材质修改

2. **场景漫游演示** (~1分钟)
   - V键进入自由相机模式
   - 演示轨道旋转、平移、缩放
   - 演示F键适应窗口功能

3. **光照系统演示** (~30秒)
   - 演示L键开关光照
   - 演示K键切换光源类型
   - 演示方向键移动光源

4. **游戏玩法演示** (~1分钟)
   - 第一/第三人称切换
   - 射击敌人
   - 展示血量系统
   - 展示游戏结束界面

5. **录制功能演示** (~30秒)
   - R键开始录制
   - P键截图
   - 展示输出文件

---

## 9. 已知限制

1. **平台限制**: 仅支持 Windows 32位
2. **图形限制**: 使用 OpenGL 固定管线，不支持着色器
3. **FFmpeg依赖**: 录制功能需要 FFmpeg DLL
4. **性能**: 大量敌人时可能影响帧率

---

## 10. 参考资料

1. OpenGL Programming Guide (Red Book)
2. GLUT Programming Documentation
3. FFmpeg Libav Documentation
4. Separating Axis Theorem for Collision Detection

---

**文档版本**: 1.0
**最后更新**: 2026年1月
**作者**: ZJU CS3134M 课程项目组